---
# https://taskfile.dev
version: '3'
env:
  ENV: testing
dotenv: ['.env', '.env.{{.ENV}}']
includes:
  writer_agent:
    taskfile: ./writer_agent/Taskfile.yml
    dir: ./writer_agent
  requirement_analyzer_agent:
    taskfile: ./requirement_analyzer_agent/Taskfile.yml
    dir: ./requirement_analyzer_agent
  questionnaire_agent:
    taskfile: ./questionnaire_agent/Taskfile.yml
    dir: ./questionnaire_agent
  clarifier_agent:
    taskfile: ./clarifier_agent/Taskfile.yml
    dir: ./clarifier_agent
  architecture_agent:
    taskfile: ./architecture_agent/Taskfile.yml
    dir: ./architecture_agent
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra
  frontend_web:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  web:
    taskfile: ./web/Taskfile.yaml
    dir: ./web
  mcp_server:
    taskfile: ./mcp_server/Taskfile.yaml
    dir: ./mcp_server
tasks:
  default:
    desc: "â„¹ï¸ Show all available tasks (run `task --list-all` to see hidden tasks)"
    cmds:
      - task --list --sort none
    silent: true

  start:
    desc: "ğŸ’» Prepare local development environment"
    cmds:
      - dr dotenv setup
      - task: install

  lint:
    desc: "ğŸ§¹ Run linters"
    cmds:
      - task: writer_agent:lint
      - task: requirement_analyzer_agent:lint
      - task: questionnaire_agent:lint
      - task: clarifier_agent:lint
      - task: architecture_agent:lint
      - task: infra:lint
      - task: frontend_web:lint
      - task: web:lint

  install:
    desc: "ğŸ› ï¸ Install all dependencies for agent and infra"
    cmds:
      - task: writer_agent:install
      - task: requirement_analyzer_agent:install
      - task: questionnaire_agent:install
      - task: clarifier_agent:install
      - task: architecture_agent:install
      - task: infra:install
      - task: frontend_web:install
      - task: web:install
      - task: mcp_server:install

  dev:
    desc: "ğŸš€ Run agent, backend (web), mcp server and frontend together"
    cmds:
      - |
        task mcp_server:dev &
        sleep 3
        task web:dev-agent &
        sleep 5
        task agent:dev &
        sleep 3
        task frontend_web:dev &
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        echo "ğŸ”— Backend: ${prefix}8080"
        echo "ğŸ”— Frontend: ${prefix}5173"
        echo "ğŸ”— Agent: ${prefix}8842"
        echo "ğŸ”— MCP Server: ${prefix}9000"
        wait

  deploy:
    desc: "ğŸš€ Deploy all services"
    env:
      AGENT_DEPLOY: "1"
    cmds:
      - task: mcp_server:install
      - task: infra:up
